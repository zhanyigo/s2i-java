#!/bin/bash -e
#
# S2I run script for the 's2i-java' image.
# The run script executes the server that runs your application.
#
# For more information see the documentation:
#	https://github.com/openshift/source-to-image/blob/master/docs/builder_image.md
#

TEST_MODE="${TEST_MODE:-0}"
JAVA_MAX_RAM_PERCENTAGE=${JAVA_MAX_RAM_PERCENTAGE:-85.00}
JACOCO_OUTPUT_PATH="${JACOCO_OUTPUT_PATH:-/opt/openshift/jacoco}"
JAVA_OPTS=${JAVA_OPTS:""}

if [ "$TEST_MODE" == "1" ]; then
    if [ "x$JACOCO_SESSION_ID" == "x" ]; then
        echo "JACOCO_SESSION_ID is null."
        exit -1;
    fi

    echo "JACOCO_OUTPUT_PATH=$JACOCO_OUTPUT_PATH"

    if [ ! -d "$JACOCO_OUTPUT_PATH/$sessionid" ]; then
        echo "mkdir $JACOCO_OUTPUT_PATH/$sessionid ..."
        mkdir -p $JACOCO_OUTPUT_PATH/$sessionid
    fi

    echo "Copy source code to: $JACOCO_OUTPUT_PATH/$sessionid"
    cp -r /opt/openshift/source $JACOCO_OUTPUT_PATH/$sessionid
    echo "Copy classes to: $JACOCO_OUTPUT_PATH/$sessionid"
    cp -r /opt/openshift/classes $JACOCO_OUTPUT_PATH/$sessionid

    JAVA_OPTS=" -javaagent:${JACOCO_AGENT}=output=file,append=true,destfile=$JACOCO_OUTPUT_PATH/$sessionid/jacoco.exec,sessionid=$JACOCO_SESSION_ID,excludes=*.scf.*:*.entity.*:*.entities.* $JAVA_OPTS"
fi

export JAVA_OPTS;

cd /opt/openshift && \
exec java \
    $JAVA_OPTS -Djava.security.egd=file:/dev/./urandom \
    -XX:OnOutOfMemoryError="kill -9 %p" -XX:+PrintFlagsFinal -XX:+UseContainerSupport -XX:MaxRAMPercentage=$JAVA_MAX_RAM_PERCENTAGE \
    -jar /opt/openshift/app.jar \
    $APP_OPTIONS

echo "Main application exited."
